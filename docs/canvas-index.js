(()=>{var Mt=Object.create;var Ne=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var Ct=Object.getOwnPropertyNames;var It=Object.getPrototypeOf,Ot=Object.prototype.hasOwnProperty;var Le=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var Rt=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Ct(e))!Ot.call(n,o)&&o!==t&&Ne(n,o,{get:()=>e[o],enumerable:!(r=lt(e,o))||r.enumerable});return n};var Pe=(n,e,t)=>(t=n!=null?Mt(It(n)):{},Rt(e||!n||!n.__esModule?Ne(t,"default",{value:n,enumerable:!0}):t,n));var ke=Le(me=>{"use strict";Object.defineProperty(me,"__esModule",{value:!0});var se=class{constructor(){this.listeners=[],this.length=()=>this.listeners.length}add(e){return this.listeners.push(e),()=>{let t=this.listeners.indexOf(e);t>=0&&this.listeners.splice(t,1)}}trigger(e){for(let t of this.listeners)if(t(e)===!1)break}};me.default=se});var Je=Le((Tn,$e)=>{"use strict";$e.exports=function n(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,o,c;if(Array.isArray(e)){if(r=e.length,r!=t.length)return!1;for(o=r;o--!==0;)if(!n(e[o],t[o]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if(c=Object.keys(e),r=c.length,r!==Object.keys(t).length)return!1;for(o=r;o--!==0;)if(!Object.prototype.hasOwnProperty.call(t,c[o]))return!1;for(o=r;o--!==0;){var a=c[o];if(!n(e[a],t[a]))return!1}return!0}return e!==e&&t!==t}});var Fe=Pe(ke());function H(n){return n*Math.PI/180}var j=class{width;height;xPos;yPos;xIndex;yIndex;worker;imageData;onRender;constructor(e,t,r,o,c,a){this.width=e,this.height=t,this.xPos=r,this.yPos=o,this.xIndex=c,this.yIndex=a,this.imageData=new ArrayBuffer(e*t*4),this.worker=new Worker("worker.js"),this.worker.addEventListener("message",this.handleMessage),this.onRender=new Fe.default}updateCanvasSize=(e,t,r,o)=>{this.width=e,this.height=t,this.xPos=r,this.yPos=o};doRender=(e,t,r,o,c,a)=>{let s=t/Math.tan(H(45)*.5),m={type:"render",buffer:this.imageData,xPos:this.xPos,yPos:this.yPos,width:this.width,height:this.height,numLights:a.getNumLights(),lightData:a.getLightDataArray(),operations:a.getOperationNumbers(),shapeData:a.getShapeDataArray(),cameraPosition:r,cameraMatrix:o,cameraZDir:s,totalHeight:t,totalWidth:e,time:c};this.worker.postMessage(m,[this.imageData])};getImageData=()=>this.imageData;handleMessage=e=>{e.data.type==="render"&&(this.imageData=e.data.buffer,this.onRender.trigger(this))}};var h=class n{static EPSILON=1e-6;static ANGLE_ORDER="zyx";static DegToRad=Math.PI/180;static RadToDeg=180/Math.PI;static toRadian(e){return e*this.DegToRad}equals(e,t){return Math.abs(e-t)<=n.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}static clamp(e,t,r){return Math.max(Math.min(e,r),t)}static lerp(e,t,r){return e+(t-e)*r}static moveTowards(e,t,r){let o=t-e;return Math.abs(o)<=r?t:e+Math.sign(o)*r}inverseLerp(e,t,r){return e===t?0:(r-e)/(t-e)}};function We(){return{m00:1,m01:0,m02:0,m10:0,m11:1,m12:0,m20:0,m21:0,m22:1}}function T(n){return Math.sqrt(n.x**2+n.y**2+n.z**2)}function ue(n){return n.x**2+n.y**2+n.z**2}function xe(n,e,t){return n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n}function G(n,e,t){return n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z,n}function N(n,e){return{x:n.x-e.x,y:n.y-e.y,z:n.z-e.z}}function Ee(n,e,t){return n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z,n}function Be(n,e,t){return n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n}function X(n,e){return{x:n.x*e,y:n.y*e,z:n.z*e}}function O(n,e,t,r){return n.x=e.x+t.x*r,n.y=e.y+t.y*r,n.z=e.z+t.z*r,n}function Ve(n){return{x:-n.x,y:-n.y,z:-n.z}}function L(n,e){let t=ue(e);return t>0&&(t=1/Math.sqrt(t)),n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n}function P(n){let e=ue(n);return e>0&&(e=1/Math.sqrt(e)),{x:n.x*e,y:n.y*e,z:n.z*e}}function Ue(n,e,t){let r=n**2+e**2+t**2;return r>0&&(r=1/Math.sqrt(r)),{x:n*r,y:e*r,z:t*r}}function k(n,e){return n.x*e.x+n.y*e.y+n.z*e.z}function Q(n,e,t){let r=e.y*t.z-e.z*t.y,o=e.z*t.x-e.x*t.z,c=e.x*t.y-e.y*t.x;return n.x=r,n.y=o,n.z=c,n}function Ze(n,e,t){let r=e.x,o=e.y,c=e.z;return n.x=r*t.m00+o*t.m10+c*t.m20,n.y=r*t.m01+o*t.m11+c*t.m21,n.z=r*t.m02+o*t.m12+c*t.m22,n}function He(n,e,t){if(t.x===0&&t.y===0&&t.z===0&&t.w===1)return n.x=e.x,n.y=e.y,n.z=e.z,n;let r=e.x,o=e.y,c=e.z,a=t.w*2,s=t.y*c-t.z*o,m=t.z*r-t.x*c,u=t.x*o-t.y*r,y=(t.y*u-t.z*m)*2,i=(t.z*s-t.x*u)*2,p=(t.x*m-t.y*s)*2;return s*=a,m*=a,u*=a,n.x=r+s+y,n.y=o+m+i,n.z=c+u+p,n}function x(){return{x:0,y:0,z:0}}function ie(n){return{x:Math.abs(n.x),y:Math.abs(n.y),z:Math.abs(n.z)}}function je(n,e){return{x:Math.max(n.x,e),y:Math.max(n.y,e),z:Math.max(n.z,e)}}function Ge(){return{m00:1,m01:0,m02:0,m03:0,m10:0,m11:1,m12:0,m13:0,m20:0,m21:0,m22:1,m23:0,m30:0,m31:0,m32:0,m33:1}}function ye(n,e){return Math.sqrt(n**2+e**2)}function Xe(n,e){return n.x*e.x+n.y*e.y}function Qe(){return{x:0,y:0}}function _e(){return{x:0,y:0,z:0,w:0}}function _(){return{x:1,y:1,z:1,w:1}}function R(){return{x:0,y:0,z:0,w:1}}function At(n){return n.x**2+n.y**2+n.z**2+n.w**2}function Ke(n,e,t){t=t*.5;let r=Math.sin(t);return n.x=r*e.x,n.y=r*e.y,n.z=r*e.z,n.w=Math.cos(t),n}function Ye(n){let e=At(n);return e>0&&(e=1/Math.sqrt(e)),n.x*=e,n.y*=e,n.z*=e,n.w*=e,n}var qe=Pe(Je());var pe=8,Y=-500,ze=-600,de=-700,be=-800,ve=-900,ge=-5e3,fe=-6e3,we=-7e3,he=-8e3;var Dt={none:Y,union:ze,intersection:de,subtraction:be,xor:ve},Tt={none:ge,box:fe,sphere:we,hexPrism:he};function Nt(n){return Tt[n]||ge}function Lt(n){return Dt[n]||Y}var Se=16,K=class n{lights=[];lightDataArray=[];shapes=[];shapeDataArray=[];operations=[];numberOperations=[];getLightDataArray(){return this.lightDataArray}getLights(){return this.lights}getNumLights(){return this.lights.length}getShapeDataArray(){return this.shapeDataArray}getShapes(){return this.shapes}getNumTotalShapes(){return this.shapes.length}setOperations(e){this.operations=e,this.updateOperationNumbers()}getOperations(){return this.operations}getOperationNumbers(){return this.numberOperations}setLight(e,t){if(e<0)throw new Error(`Out of bounds light index ${e}`);e>=this.lights.length?this.lights[e]={...n.createNewLight(),...t}:this.lights[e]={...this.lights[e],...t},this.updateLight(e)}updateShapesFromRootNode(e,t){if(!t[e])return;let{operations:o,shapes:c}=n.createShapesFromNode(t[e],t);this.operations=o,this.shapes=c,console.log("Shapes",this.shapes),console.log("Operations",this.operations),this.shapeDataArray.length=0;for(let a=0;a<this.shapes.length;a++)this.updateShape(a);this.updateOperationNumbers()}static createShapesFromNode(e,t){let r=[],o=[];return this.pushToStack(r,o,e,t),r.reverse(),{operations:r,shapes:o}}static pushToStack(e,t,r,o){if(r.childOpCode!==void 0&&r.childOpCode!=="none"&&e.push(r.childOpCode),r.shape!==void 0){let c=t.findIndex(a=>(0,qe.default)(a,r.shape));c<0&&(c=t.length,t.push(r.shape)),e.push(c)}if(r.childrenIds!==void 0)for(let c of r.childrenIds)this.pushToStack(e,t,o[c],o)}setShape(e,t){if(e<0)throw new Error(`Out of bounds shape index ${e}`);e>=this.shapes.length?this.shapes[e]=n.createNewShape(t):this.shapes[e]={...this.shapes[e],...t},this.updateShape(e)}updateLight(e){let t=e*pe,r=this.lights[e];this.lightDataArray[t]=r.position.x,this.lightDataArray[t+1]=r.position.y,this.lightDataArray[t+2]=r.position.z,this.lightDataArray[t+3]=r.radius,this.lightDataArray[t+4]=r.colour.x,this.lightDataArray[t+5]=r.colour.y,this.lightDataArray[t+6]=r.colour.z,this.lightDataArray[t+7]=r.colour.w}updateShape(e){let t=e*Se,r=this.shapes[e];this.shapeDataArray[t]=r.position.x,this.shapeDataArray[t+1]=r.position.y,this.shapeDataArray[t+2]=r.position.z,this.shapeDataArray[t+3]=r.maxSize,this.shapeDataArray[t+4]=r.rotation.x,this.shapeDataArray[t+5]=r.rotation.y,this.shapeDataArray[t+6]=r.rotation.z,this.shapeDataArray[t+7]=r.rotation.w,this.shapeDataArray[t+8]=Nt(r.type),this.shapeDataArray[t+9]=r.shapeParams.x,this.shapeDataArray[t+10]=r.shapeParams.y,this.shapeDataArray[t+11]=r.shapeParams.z,this.shapeDataArray[t+12]=r.diffuseColour.x,this.shapeDataArray[t+13]=r.diffuseColour.y,this.shapeDataArray[t+14]=r.diffuseColour.z,this.shapeDataArray[t+15]=r.diffuseColour.w}updateOperationNumbers(){this.numberOperations=this.operations.map(e=>typeof e=="string"?Lt(e):e)}static createNewLight(){return{name:"Unnamed Light",position:x(),radius:10,colour:_()}}static createNewShape(e){return{position:x(),rotation:R(),maxSize:0,type:"none",shapeParams:x(),diffuseColour:{x:.7,y:.3,z:.2,w:1},specularColour:{x:1,y:.8,z:.9,w:1},...e}}};var et=255,tt=1e-4,S=x(),M=x(),$=x();function le(n,e,t,r){G(S,t,e),L(S,S),Q(M,S,r),L(M,M),Q($,M,S),n.m00=M.x,n.m01=M.y,n.m02=M.z,n.m10=$.x,n.m11=$.y,n.m12=$.z,n.m20=-S.x,n.m21=-S.y,n.m22=-S.z}function nt(n,e,t,r){let o=r.x+t.x*-.5,c=r.y+t.y*-.5;return n.x=o,n.y=c,n.z=-e,L(n,n),n}var F=x();var B=_e();function rt(n,e,t,r,o){F.x=F.y=F.z=0;let c=t;for(let a=0;a<et;a++){O(F,n,e,c);let s=o(F);if(s.distance<=tt)return{distance:c,diffuseColour:s.diffuseColour};if(c+=s.distance,c>=r)break}return{distance:r,diffuseColour:B}}function Pt(n,e,t){let r=e*.0015,o={x:n.x+r,y:n.y,z:n.z},c={x:n.x-r,y:n.y,z:n.z},a=t(o),s=t(c),m=a.distance-s.distance;o.x=n.x,o.y=n.y+r,c.x=n.x,c.y=n.y-r;let u=t(o),y=t(c),i=u.distance-y.distance;o.y=n.y,o.z=n.z+r,c.y=n.y,c.z=n.z-r;let p=t(o),z=t(c),w=p.distance-z.distance;return Ue(m,i,w)}function kt(n,e,t){let r=k(e,t);return O(n,e,t,-2*r),n}function Ft(n,e,t,r,o,c,a,s){let m=Pt(o,e,n),u=P(N(a,o)),y=Ve(u),i=P(N(c,o)),p=P(kt(x(),y,m)),z=k(u,m),w=k(p,i);if(z<0)return x();let v;if(w<0)v=X(t,z);else{let U=X(t,z),C=Math.pow(w,t.w);v=X(r,C),xe(v,v,U)}return Ee(v,v,s),v}var Me={x:.1,y:.1,z:.1};var Wt=_();function ot(n,e,t,r,o,c){let a={x:Me.x,y:Me.y,z:Me.z};for(let s=0;s<o;s++){let m=s*pe,u={x:c[m],y:c[m+1],z:c[m+2]},y=c[m+3],i={x:c[m+4],y:c[m+5],z:c[m+6]},p=P(N(u,t)),z=Bt(n,t,p,.1,100),w=Ft(n,e.distance,e.diffuseColour,Wt,t,r,u,i);xe(a,a,Be(w,w,z))}return a}var Et=32,W=x();function Bt(n,e,t,r,o){let c=1;W.x=W.y=W.z=0;let a=r;for(let s=0;s<et&&a<o;s++){O(W,e,t,a);let m=n(W);if(m.distance<tt)return m.distance;c=Math.min(c,Et*m.distance/a),a+=m.distance}return c}function ct(n,e){return T(n)-e}function at(n,e){let t=N(ie(n),e),r=T(je(t,0)),o=Math.min(Math.max(t.x,Math.max(t.y,t.z)),0);return r+o}var E={x:-.8660254,y:.5,z:.57735};function st(n,e){let t=ie(n),r=2*Math.min(Xe(E,t),0);t.x-=r*E.x,t.y-=r*E.y;let o=h.clamp(t.x,-E.z*e.x,E.z*e.x),c=ye(t.x-o,t.y-e.x)*Math.sign(t.y-e.x),a=t.z-e.y,s=Math.max(c,0),m=Math.max(a,0);return Math.min(Math.max(c,a),0)+ye(s,m)}function mt(n,e){return Math.max(Math.min(n,e),-Math.max(n,e))}var pr=Ge(),ut=x(),A=R();var V=[],l=x();function Vt(n,e,t){let r=n*Se;l.x=t[r],l.y=t[r+1],l.z=t[r+2];let o=t[r+3];if(G(l,l,e),o>0){let u=T(l);if(u>o+3)return{distance:u-3,diffuseColour:B}}A.x=t[r+4],A.y=t[r+5],A.z=t[r+6],A.w=t[r+7],He(ut,l,A);let c=t[r+8],a={x:t[r+9],y:t[r+10],z:t[r+11]},s=Ut(c,ut,a),m={x:t[r+12],y:t[r+13],z:t[r+14],w:t[r+15]};return{distance:s,diffuseColour:m}}function xt(n,e,t){let r=0,o=-1;for(;r<t.length;){let c=t[r++];if(c<=Y){let a=V[o--],s=V[o--],m=Zt(c,a,s);V[++o]=m}else{let a=Vt(c,n,e);V[++o]=a}}return V[0]}function Ut(n,e,t){switch(n){case fe:return at(e,t);case we:return ct(e,t.x);case he:return st(e,t)}return 100}function Zt(n,e,t){switch(n){case ze:return e.distance<t.distance?e:t;case de:return e.distance>t.distance?e:t;case be:return-e.distance>t.distance?{distance:-e.distance,diffuseColour:e.diffuseColour}:t;case ve:return{distance:mt(e.distance,t.distance),diffuseColour:e.diffuseColour}}return{distance:100,diffuseColour:B}}var Ht={x:0,y:0,z:0,w:255},jt={x:255,y:0,z:0,w:255},Gt=0;function it(n){let e=0,{buffer:t,width:r,height:o,totalHeight:c,totalWidth:a,xPos:s,yPos:m,cameraMatrix:u,cameraPosition:y,cameraZDir:i,time:p,numLights:z,lightData:w,operations:v,shapeData:U}=n,C=new Uint8ClampedArray(t);Gt=Math.sin(p)*.5+.5;let wt={x:a,y:c},ht=x(),Ae=x(),re=Qe();Ke(A,{x:0,y:1,z:0},p);for(let oe=0;oe<o;oe++)for(let ce=0;ce<r;ce++){re.x=ce+s,re.y=c-(oe+m);let Z=nt(ht,i,wt,re);Ze(Z,Z,u);let D={distance:100,diffuseColour:B},De=rt(y,Z,0,100,Te=>xt(Te,U,v));De.distance<D.distance&&(D=De);let I=jt;if(D.distance>99)I=Ht;else{O(Ae,y,Z,D.distance);let ae=ot(St=>xt(St,U,v),D,Ae,y,z,w);I={x:ae.x*255,y:ae.y*255,z:ae.z*255,w:255}}C[e]=I.x,C[e+1]=I.y,C[e+2]=I.z,C[e+3]=I.w,e+=4}}var Re=[],J=1,q=navigator.hardwareConcurrency,d,Ie=0,g=!0,Oe,pt,ee=1,te=!1,b=new K;function Xt(){let n=document.getElementById("toggle-render");n.addEventListener("click",()=>{g?(n.innerText="Start",g=!1):(n.innerText="Stop",g=!0,Ce())}),document.getElementById("select-render-scale").addEventListener("change",t=>{let r=t.target.value,o=Number.parseFloat(r);isFinite(o)?(ee=o,yt()):console.warn("Unable to parse canvas scale",r)}),window.addEventListener("resize",t=>{yt(),te||Ce()});let e=document.getElementById("main-canvas");e?(Qt(e),b.setShape(0,{type:"sphere",shapeParams:{x:2,y:2,z:1},maxSize:2,diffuseColour:{x:.1,y:.9,z:.2,w:1}}),b.setShape(1,{type:"sphere",shapeParams:{x:1.5,y:2,z:0},maxSize:1.5}),b.setShape(2,{type:"box",shapeParams:{x:6,y:1,z:6},position:{x:0,y:-1.5,z:0},diffuseColour:{x:.2,y:.25,z:.3,w:1}}),b.setOperations([0,2,"union",1,"subtraction"]),te?(Oe=new ArrayBuffer(window.innerWidth*window.innerHeight*4),pt=new Uint8ClampedArray(Oe)):_t(),te||Ce()):console.error("Couldn't find main-canvas")}function Ce(){zt(),te?Kt():ft()}function zt(){let n=Date.now()/1e3,e=Math.sin(n)*7,t=Math.cos(n)*7;b.setLight(0,{position:{x:e,z:t,y:1.5}}),b.setShape(1,{position:{x:e/5,y:t/7,z:0}})}function Qt(n){d=n.getContext("2d"),dt(window.innerWidth,window.innerHeight),d.fillRect(0,0,d.canvas.width,d.canvas.height)}function dt(n,e){d.canvas.width=n,d.canvas.height=e}function yt(){let n=window.innerWidth*ee,e=window.innerHeight*ee;console.log("Updating canvas size to",n,e,ee),dt(n,e)}function _t(){let n=d.canvas.width,e=d.canvas.height,t=Math.floor(n/J),r=Math.floor(e/q),o=n-t*(J-1),c=e-r*(q-1),a=0,s=0;for(let u=0;u<q;u++){let y=u>0&&u===q-1?c:r;for(let i=0;i<J;i++){let p=i>0&&i===J-1?o:t,z=new j(p,y,a,s,i,u);z.onRender.add(Yt),Re.push(z),a+=p}a=0,s+=y}let m=R();Ye(m)}function Kt(){console.time("Main thread render");let n=0,e=Math.sin(n)*20,t=Math.cos(n)*20;f.x=e,f.y=3,f.z=t,le(ne,f,bt,vt);let{width:r,height:o}=d.canvas,c=o/Math.tan(H(45)*.5),a={type:"render",numLights:b.getNumLights(),lightData:b.getLightDataArray(),operations:b.getOperationNumbers(),shapeData:b.getShapeDataArray(),width:r,height:o,totalWidth:r,totalHeight:o,buffer:Oe,xPos:0,yPos:0,cameraMatrix:ne,cameraPosition:f,cameraZDir:c,time:n};it(a);let s=new ImageData(pt,r,o);d.putImageData(s,0,0),console.timeEnd("Main thread render")}var ne=We(),f=x(),bt=x(),vt={x:0,y:1,z:0};function ft(){if(!g)return;zt(),console.time("Render");let{width:n,height:e}=d.canvas,t=0,r=Math.sin(t)*20,o=Math.cos(t)*20;f.x=r,f.y=5,f.z=o,le(ne,f,bt,vt);for(let c of Re)Ie++,c.doRender(n,e,f,ne,t,b)}function Yt(n){Ie--,Ie===0&&(console.timeEnd("Render"),$t())}function $t(){console.log("Applying worker renders");for(let n of Re){let e=new Uint8ClampedArray(n.getImageData()),t=new ImageData(e,n.width,n.height);d.putImageData(t,n.xPos,n.yPos)}requestAnimationFrame(ft)}Xt();})();
//# sourceMappingURL=canvas-index.js.map
