(()=>{var vt=Object.create;var Le=Object.defineProperty;var wt=Object.getOwnPropertyDescriptor;var Mt=Object.getOwnPropertyNames;var ft=Object.getPrototypeOf,St=Object.prototype.hasOwnProperty;var ht=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var lt=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Mt(e))!St.call(t,o)&&o!==n&&Le(t,o,{get:()=>e[o],enumerable:!(r=wt(e,o))||r.enumerable});return t};var Ct=(t,e,n)=>(n=t!=null?vt(ft(t)):{},lt(e||!t||!t.__esModule?Le(n,"default",{value:t,enumerable:!0}):n,t));var Pe=ht(se=>{"use strict";Object.defineProperty(se,"__esModule",{value:!0});var me=class{constructor(){this.listeners=[],this.length=()=>this.listeners.length}add(e){return this.listeners.push(e),()=>{let n=this.listeners.indexOf(e);n>=0&&this.listeners.splice(n,1)}}trigger(e){for(let n of this.listeners)if(n(e)===!1)break}};se.default=me});var Ne=Ct(Pe());function U(t){return t*Math.PI/180}var G=class{width;height;xPos;yPos;xIndex;yIndex;worker;imageData;onRender;constructor(e,n,r,o,c,a){this.width=e,this.height=n,this.xPos=r,this.yPos=o,this.xIndex=c,this.yIndex=a,this.imageData=new ArrayBuffer(e*n*4),this.worker=new Worker("worker.js"),this.worker.addEventListener("message",this.handleMessage),this.onRender=new Ne.default}updateCanvasSize=(e,n,r,o)=>{this.width=e,this.height=n,this.xPos=r,this.yPos=o};doRender=(e,n,r,o,c,a)=>{let m=n/Math.tan(U(45)*.5),s={type:"render",buffer:this.imageData,xPos:this.xPos,yPos:this.yPos,width:this.width,height:this.height,numLights:a.getNumLights(),lightData:a.getLightDataArray(),operations:a.getOperationNumbers(),shapeData:a.getShapeDataArray(),cameraPosition:r,cameraMatrix:o,cameraZDir:m,totalHeight:n,totalWidth:e,time:c};this.worker.postMessage(s,[this.imageData])};getImageData=()=>this.imageData;handleMessage=e=>{e.data.type==="render"&&(this.imageData=e.data.buffer,this.onRender.trigger(this))}};var M=class t{static EPSILON=1e-6;static ANGLE_ORDER="zyx";static DegToRad=Math.PI/180;static RadToDeg=180/Math.PI;static toRadian(e){return e*this.DegToRad}equals(e,n){return Math.abs(e-n)<=t.EPSILON*Math.max(1,Math.abs(e),Math.abs(n))}static clamp(e,n,r){return Math.max(Math.min(e,r),n)}static lerp(e,n,r){return e+(n-e)*r}static moveTowards(e,n,r){let o=n-e;return Math.abs(o)<=r?n:e+Math.sign(o)*r}inverseLerp(e,n,r){return e===n?0:(r-e)/(n-e)}};function ke(){return{m00:1,m01:0,m02:0,m10:0,m11:1,m12:0,m20:0,m21:0,m22:1}}function T(t){return Math.sqrt(t.x**2+t.y**2+t.z**2)}function ue(t){return t.x**2+t.y**2+t.z**2}function xe(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t}function X(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t}function L(t,e){return{x:t.x-e.x,y:t.y-e.y,z:t.z-e.z}}function Fe(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t}function We(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t}function j(t,e){return{x:t.x*e,y:t.y*e,z:t.z*e}}function I(t,e,n,r){return t.x=e.x+n.x*r,t.y=e.y+n.y*r,t.z=e.z+n.z*r,t}function Ee(t){return{x:-t.x,y:-t.y,z:-t.z}}function P(t,e){let n=ue(e);return n>0&&(n=1/Math.sqrt(n)),t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t}function Be(t,e,n,r){let o=e**2+n**2+r**2;return o>0&&(o=1/Math.sqrt(o)),t.x=e*o,t.y=n*o,t.z=r*o,t}function N(t){let e=ue(t);return e>0&&(e=1/Math.sqrt(e)),{x:t.x*e,y:t.y*e,z:t.z*e}}function k(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function _(t,e,n){let r=e.y*n.z-e.z*n.y,o=e.z*n.x-e.x*n.z,c=e.x*n.y-e.y*n.x;return t.x=r,t.y=o,t.z=c,t}function Ve(t,e,n){let r=e.x,o=e.y,c=e.z;return t.x=r*n.m00+o*n.m10+c*n.m20,t.y=r*n.m01+o*n.m11+c*n.m21,t.z=r*n.m02+o*n.m12+c*n.m22,t}function Ze(t,e,n){if(n.x===0&&n.y===0&&n.z===0&&n.w===1)return t.x=e.x,t.y=e.y,t.z=e.z,t;let r=e.x,o=e.y,c=e.z,a=n.w*2,m=n.y*c-n.z*o,s=n.z*r-n.x*c,u=n.x*o-n.y*r,p=(n.y*u-n.z*s)*2,i=(n.z*m-n.x*u)*2,z=(n.x*s-n.y*m)*2;return m*=a,s*=a,u*=a,t.x=r+m+p,t.y=o+s+i,t.z=c+u+z,t}function x(){return{x:0,y:0,z:0}}function ie(t){return{x:Math.abs(t.x),y:Math.abs(t.y),z:Math.abs(t.z)}}function He(t,e){return{x:Math.max(t.x,e),y:Math.max(t.y,e),z:Math.max(t.z,e)}}function Ue(){return{m00:1,m01:0,m02:0,m03:0,m10:0,m11:1,m12:0,m13:0,m20:0,m21:0,m22:1,m23:0,m30:0,m31:0,m32:0,m33:1}}function ye(t,e){return Math.sqrt(t**2+e**2)}function Ge(t,e){return t.x*e.x+t.y*e.y}function Xe(){return{x:0,y:0}}function je(){return{x:0,y:0,z:0,w:0}}function Q(){return{x:1,y:1,z:1,w:1}}function A(){return{x:0,y:0,z:0,w:1}}function Rt(t){return t.x**2+t.y**2+t.z**2+t.w**2}function _e(t,e,n){n=n*.5;let r=Math.sin(n);return t.x=r*e.x,t.y=r*e.y,t.z=r*e.z,t.w=Math.cos(n),t}function Qe(t){let e=Rt(t);return e>0&&(e=1/Math.sqrt(e)),t.x*=e,t.y*=e,t.z*=e,t.w*=e,t}var pe=8,Y=-500,ze=-600,be=-700,de=-800,ve=-900,Ke=-5e3,we=-6e3,Me=-7e3,fe=-8e3,It={none:Y,union:ze,intersection:be,subtraction:de,xor:ve},At={none:Ke,box:we,sphere:Me,hexPrism:fe};function Dt(t){return At[t]||Ke}function Ot(t){return It[t]||Y}var Se=16,K=class{lights=[];lightDataArray=[];shapes=[];shapeDataArray=[];operations=[];numberOperations=[];getLightDataArray(){return this.lightDataArray}getLights(){return this.lights}getNumLights(){return this.lights.length}getShapeDataArray(){return this.shapeDataArray}getShapes(){return this.shapes}getNumTotalShapes(){return this.shapes.length}setOperations(e){this.operations=e,this.updateOperationNumbers()}getOperations(){return this.operations}getOperationNumbers(){return this.numberOperations}setLight(e,n){if(e<0)throw new Error(`Out of bounds light index ${e}`);e>=this.lights.length?this.lights[e]={...this.createNewLight(),...n}:this.lights[e]={...this.lights[e],...n},this.updateLight(e)}setShape(e,n){if(e<0)throw new Error(`Out of bounds shape index ${e}`);e>=this.shapes.length?this.shapes[e]={...this.createNewShape(),...n}:this.shapes[e]={...this.shapes[e],...n},this.updateShape(e)}updateLight(e){let n=e*pe,r=this.lights[e];this.lightDataArray[n]=r.position.x,this.lightDataArray[n+1]=r.position.y,this.lightDataArray[n+2]=r.position.z,this.lightDataArray[n+3]=r.radius,this.lightDataArray[n+4]=r.colour.x,this.lightDataArray[n+5]=r.colour.y,this.lightDataArray[n+6]=r.colour.z,this.lightDataArray[n+7]=r.colour.w}updateShape(e){let n=e*Se,r=this.shapes[e];this.shapeDataArray[n]=r.position.x,this.shapeDataArray[n+1]=r.position.y,this.shapeDataArray[n+2]=r.position.z,this.shapeDataArray[n+3]=r.maxSize,this.shapeDataArray[n+4]=r.rotation.x,this.shapeDataArray[n+5]=r.rotation.y,this.shapeDataArray[n+6]=r.rotation.z,this.shapeDataArray[n+7]=r.rotation.w,this.shapeDataArray[n+8]=Dt(r.type),this.shapeDataArray[n+9]=r.shapeParams.x,this.shapeDataArray[n+10]=r.shapeParams.y,this.shapeDataArray[n+11]=r.shapeParams.z,this.shapeDataArray[n+12]=r.diffuseColour.x,this.shapeDataArray[n+13]=r.diffuseColour.y,this.shapeDataArray[n+14]=r.diffuseColour.z,this.shapeDataArray[n+15]=r.diffuseColour.w}updateOperationNumbers(){this.numberOperations=this.operations.map(e=>typeof e=="string"?Ot(e):e)}createNewLight(){return{position:x(),radius:10,colour:Q()}}createNewShape(){return{position:x(),rotation:A(),maxSize:0,type:"none",shapeParams:x(),diffuseColour:{x:.7,y:.3,z:.2,w:1},specularColour:{x:1,y:.8,z:.9,w:1}}}};var Ye=255,$e=1e-4,f=x(),h=x(),$=x();function le(t,e,n,r){X(f,n,e),P(f,f),_(h,f,r),P(h,h),_($,h,f),t.m00=h.x,t.m01=h.y,t.m02=h.z,t.m10=$.x,t.m11=$.y,t.m12=$.z,t.m20=-f.x,t.m21=-f.y,t.m22=-f.z}function Je(t,e,n,r){let o=r.x+n.x*-.5,c=r.y+n.y*-.5;return t.x=o,t.y=c,t.z=-e,P(t,t),t}var F=x();var B=je();function qe(t,e,n,r,o){F.x=F.y=F.z=0;let c=n;for(let a=0;a<Ye;a++){I(F,t,e,c);let m=o(F);if(m.distance<=$e)return{distance:c,diffuseColour:m.diffuseColour};if(c+=m.distance,c>=r)break}return{distance:r,diffuseColour:B}}function Tt(t,e,n){let r=e*.0015,o={x:t.x+r,y:t.y,z:t.z},c=n(o).distance;o.x=t.x,o.y=t.y+r;let a=n(o).distance;o.y=t.y,o.z=t.z+r;let m=n(o).distance;return Be(o,c-e,a-e,m-e)}function Lt(t,e,n){let r=k(e,n);return I(t,e,n,-2*r),t}function Pt(t,e,n,r,o,c,a,m){let s=Tt(o,e,t),u=N(L(a,o)),p=Ee(u),i=N(L(c,o)),z=N(Lt(x(),p,s)),d=k(u,s),S=k(z,i);if(d<0)return x();let v;if(S<0)v=j(n,d);else{let Z=j(n,d),C=Math.pow(S,n.w);v=j(r,C),xe(v,v,Z)}return Fe(v,v,m),v}var he={x:.1,y:.1,z:.1};var Nt=Q();function ge(t,e,n,r,o,c){let a={x:he.x,y:he.y,z:he.z};for(let m=0;m<o;m++){let s=m*pe,u={x:c[s],y:c[s+1],z:c[s+2]},p=c[s+3],i={x:c[s+4],y:c[s+5],z:c[s+6]},z=N(L(u,n)),d=Ft(t,n,z,.1,100),S=Pt(t,e.distance,e.diffuseColour,Nt,n,r,u,i);xe(a,a,We(S,S,d))}return a}var kt=32,W=x();function Ft(t,e,n,r,o){let c=1;W.x=W.y=W.z=0;let a=r;for(let m=0;m<Ye&&a<o;m++){I(W,e,n,a);let s=t(W);if(s.distance<$e)return s.distance;c=Math.min(c,kt*s.distance/a),a+=s.distance}return c}function et(t,e){return T(t)-e}function tt(t,e){let n=L(ie(t),e),r=T(He(n,0)),o=Math.min(Math.max(n.x,Math.max(n.y,n.z)),0);return r+o}var E={x:-.8660254,y:.5,z:.57735};function nt(t,e){let n=ie(t),r=2*Math.min(Ge(E,n),0);n.x-=r*E.x,n.y-=r*E.y;let o=M.clamp(n.x,-E.z*e.x,E.z*e.x),c=ye(n.x-o,n.y-e.x)*Math.sign(n.y-e.x),a=n.z-e.y,m=Math.max(c,0),s=Math.max(a,0);return Math.min(Math.max(c,a),0)+ye(m,s)}function rt(t,e){return Math.max(Math.min(t,e),-Math.max(t,e))}var ur=Ue(),ot=x(),D=A();var V=[],l=x();function Wt(t,e,n){let r=t*Se;l.x=n[r],l.y=n[r+1],l.z=n[r+2];let o=n[r+3];if(X(l,l,e),o>0){let u=T(l);if(u>o+3)return{distance:u-3,diffuseColour:B}}D.x=n[r+4],D.y=n[r+5],D.z=n[r+6],D.w=n[r+7],Ze(ot,l,D);let c=n[r+8],a={x:n[r+9],y:n[r+10],z:n[r+11]},m=Et(c,ot,a),s={x:n[r+12],y:n[r+13],z:n[r+14],w:n[r+15]};return{distance:m,diffuseColour:s}}function ct(t,e,n){let r=0,o=-1;for(;r<n.length;){let c=n[r++];if(c<=Y){let a=V[o--],m=V[o--],s=Bt(c,a,m);V[++o]=s}else{let a=Wt(c,t,e);V[++o]=a}}return V[0]}function Et(t,e,n){switch(t){case we:return tt(e,n);case Me:return et(e,n.x);case fe:return nt(e,n)}return 100}function Bt(t,e,n){switch(t){case ze:return e.distance<n.distance?e:n;case be:return e.distance>n.distance?e:n;case de:return-e.distance>n.distance?{distance:-e.distance,diffuseColour:e.diffuseColour}:n;case ve:return{distance:rt(e.distance,n.distance),diffuseColour:e.diffuseColour}}return{distance:100,diffuseColour:B}}var Vt={x:0,y:0,z:0,w:255},Zt={x:255,y:0,z:0,w:255},Ht=0;function at(t){let e=0,{buffer:n,width:r,height:o,totalHeight:c,totalWidth:a,xPos:m,yPos:s,cameraMatrix:u,cameraPosition:p,cameraZDir:i,time:z,numLights:d,lightData:S,operations:v,shapeData:Z}=t,C=new Uint8ClampedArray(n);Ht=Math.sin(z)*.5+.5;let zt={x:a,y:c},bt=x(),De=x(),re=Xe();_e(D,{x:0,y:1,z:0},z);for(let oe=0;oe<o;oe++)for(let ce=0;ce<r;ce++){re.x=ce+m,re.y=c-(oe+s);let H=Je(bt,i,zt,re);Ve(H,H,u);let O={distance:100,diffuseColour:B},Oe=qe(p,H,0,100,Te=>ct(Te,Z,v));Oe.distance<O.distance&&(O=Oe);let R=Zt;if(O.distance>99)R=Vt;else{I(De,p,H,O.distance);let ae=ge(dt=>ct(dt,Z,v),O,De,p,d,S);R={x:Math.pow(ae.x,.4545)*255,y:Math.pow(ae.y,.4545)*255,z:Math.pow(ae.z,.4545)*255,w:255}}C[e]=R.x,C[e+1]=R.y,C[e+2]=R.z,C[e+3]=R.w,e+=4}}var Ae=[],J=1,q=navigator.hardwareConcurrency,y,Re=0,g=!0,Ie,st,ee=1,te=!1,b=new K;function Ut(){let t=document.getElementById("toggle-render");t.addEventListener("click",()=>{g?(t.innerText="Start",g=!1):(t.innerText="Stop",g=!0,Ce())}),document.getElementById("select-render-scale").addEventListener("change",n=>{let r=n.target.value,o=Number.parseFloat(r);isFinite(o)?(ee=o,mt()):console.warn("Unable to parse canvas scale",r)}),window.addEventListener("resize",n=>{mt(),te||Ce()});let e=document.getElementById("main-canvas");e?(Gt(e),b.setShape(0,{type:"sphere",shapeParams:{x:2,y:2,z:1},maxSize:2,diffuseColour:{x:.1,y:.9,z:.2,w:1}}),b.setShape(1,{type:"sphere",shapeParams:{x:1.5,y:2,z:0},maxSize:1.5}),b.setShape(2,{type:"box",shapeParams:{x:6,y:1,z:6},position:{x:0,y:-1.5,z:0},diffuseColour:{x:.2,y:.25,z:.3,w:1}}),b.setOperations([0,2,"union",1,"subtraction"]),te?(Ie=new ArrayBuffer(window.innerWidth*window.innerHeight*4),st=new Uint8ClampedArray(Ie)):Xt(),te||Ce()):console.error("Couldn't find main-canvas")}function Ce(){ut(),te?jt():pt()}function ut(){let t=Date.now()/1e3,e=Math.sin(t)*7,n=Math.cos(t)*7;b.setLight(0,{position:{x:e,z:n,y:1.5}}),b.setShape(1,{position:{x:e/5,y:n/7,z:0}})}function Gt(t){y=t.getContext("2d"),xt(window.innerWidth,window.innerHeight),y.fillRect(0,0,y.canvas.width,y.canvas.height)}function xt(t,e){y.canvas.width=t,y.canvas.height=e}function mt(){let t=window.innerWidth*ee,e=window.innerHeight*ee;console.log("Updating canvas size to",t,e,ee),xt(t,e)}function Xt(){let t=y.canvas.width,e=y.canvas.height,n=Math.floor(t/J),r=Math.floor(e/q),o=t-n*(J-1),c=e-r*(q-1),a=0,m=0;for(let u=0;u<q;u++){let p=u>0&&u===q-1?c:r;for(let i=0;i<J;i++){let z=i>0&&i===J-1?o:n,d=new G(z,p,a,m,i,u);d.onRender.add(_t),Ae.push(d),a+=z}a=0,m+=p}let s=A();Qe(s)}function jt(){console.time("Main thread render");let t=0,e=Math.sin(t)*20,n=Math.cos(t)*20;w.x=e,w.y=3,w.z=n,le(ne,w,it,yt);let{width:r,height:o}=y.canvas,c=o/Math.tan(U(45)*.5),a={type:"render",numLights:b.getNumLights(),lightData:b.getLightDataArray(),operations:b.getOperationNumbers(),shapeData:b.getShapeDataArray(),width:r,height:o,totalWidth:r,totalHeight:o,buffer:Ie,xPos:0,yPos:0,cameraMatrix:ne,cameraPosition:w,cameraZDir:c,time:t};at(a);let m=new ImageData(st,r,o);y.putImageData(m,0,0),console.timeEnd("Main thread render")}var ne=ke(),w=x(),it=x(),yt={x:0,y:1,z:0};function pt(){if(!g)return;ut(),console.time("Render");let{width:t,height:e}=y.canvas,n=0,r=Math.sin(n)*20,o=Math.cos(n)*20;w.x=r,w.y=5,w.z=o,le(ne,w,it,yt);for(let c of Ae)Re++,c.doRender(t,e,w,ne,n,b)}function _t(t){Re--,Re===0&&(console.timeEnd("Render"),Qt())}function Qt(){console.log("Applying worker renders");for(let t of Ae){let e=new Uint8ClampedArray(t.getImageData()),n=new ImageData(e,t.width,t.height);y.putImageData(n,t.xPos,t.yPos)}requestAnimationFrame(pt)}Ut();})();
//# sourceMappingURL=canvas-index.js.map
